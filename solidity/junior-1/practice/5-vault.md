# Vault

Волты (vaults) предоставляют возможность пользователям передавать свои активы в управление и получать от этого доход (yield). Это упрощает процесс формирования портфеля: пользователю не нужно изучать большое количество протоколов и разбираться в способах получения максимальной доходности. Разработчики автоматизировали все необходимые действия внутри стратегии волта, что значительно облегчает использование.

## TЗ

Необходимо написать два основных смарт-контракта, которые реализуют функционал волта:

- Vault – смарт-контракт, с которым взаимодействует конечный пользователь. Расширяет ERC20 и является share-токеном;
- Strategy – смарт-контракт, предназначенный для управления want-токенами.

### Расшифровка некоторых понятий

- **want-токен** (underlying токен) – токен, которым управляет волт. Это может быть любой ERC20 токен;
- **share-токен** – токенизированная доля пользователя в волте в формате ERC20;
- **yield** – доход пользователя.

### Как это выглядит для конечного пользователя

У пользователя есть определенное количество want-токенов. Управление этим активом самостоятельно может быть сложным, поэтому проще найти платформу, которая принимает данный актив в управление.

Пользователь находит такую платформу, видит список волтов и их доходность. Он выбирает волт, работающий с его want-токенами, и делает депозит, физически передавая want-токены в управление волту. Взамен он получает share-токены.

Затем пользователь наблюдает за ростом баланса, доступного для вывода из волта. В любой момент он может передать свои share-токены обратно волту и получить то, что вложил, плюс накопленный доход (yield), если стратегия была успешной.

### Как это выглядит со стороны смарт-контрактов (core-функционал)

Работу волта обеспечивают два основных контракта – Vault и Strategy.

Примерный воркфлоу работы волта:

1. Пользователи делают депозит в волт, на контракте волта накапливаются want-токены.
2. Стратегия забирает накопившиеся want-токены и использует их для получения дохода.
3. Через определенные промежутки времени бот активирует стратегию, чтобы она снова забрала все пользовательские депозиты из волта и отчиталась о текущих заработках или потерях.
4. Время от времени пользователи могут выходить из волта. В таком случае сначала используются свободные средства на волте; если их недостаточно, волт запрашивает недостающую сумму у стратегии.

### Ответственность волта

- Принимать от пользователей want-токены и выпускать взамен share-токены;
- Принимать и сжигать share-токены, возвращая пользователям соответствующее количество want-токенов;
- Вести учет количества want-токенов, переданных в стратегию;
- Переводить performance и management fees (комиссию) на адрес feeRecipient:
  - managementFee - это плата за использования протокола, она исчисляется в процентах годовых (например 1%) и списывается со всего депозита который обслуживает стратегия, списывается только в случае если стратегия в плюсе;
  - performanceFee - это комиссия только с доходов стратегии, а не со всего депозита, также списывается только когда стратегия что-то заработала.
  Пример:
  Стратегия управляет `1000$`. До вызова `harvest()` стратегия заработала `100$`, общее количество средств `1100$`. Предположим managementFee = 1%, performanceFee = 0.5%, тогда:
    - managementFee = 1100 * 1% / 12 = `0.92$`
    - performanceFee = 100 * 0.5% = `0.5%`
    Общая комиссия: 0.92 + 0.5 = `1.42$`. Если общая комиссия превышает доход - приравниваем ее к полученному доходу (стратегия не должна уйти в минус).

**Формула для депозита:**

![vault-formula](./img/vault-formula.png)

- *tA* – Vault.totalAssets (want-токен)
- *tS* – Vault.totalSupply (share-токен)
- *dA* – depositAmount (сумма депозита)
- *s* – shares to mint (количество share-токенов для выпуска)

### Ответственность стратегии

- Взять want-токены из волта и использовать их в соответствии с принятой стратегией управления;
- Синхронизировать доходы и убытки с волтом.


### Дополнительный функционал (обязательный)

- Возможность приостановки работы стратегии с возвратом всех want-токенов на баланс стратегии;
- Возможность экстренной остановки стратегии в случае взлома или подозрения на взлом. Необходимо максимально вернуть want-токены и перевести их на адрес владельца;
- Возможность миграции на новую стратегию. Старая стратегия должна быть опустошена и остановлена;
- Поддержка нескольких стратегий одним волтом.

### Внешние сервисы

- Настроить сервис для создания бота, который будет вызывать методы стратегии по определенным триггерам;
- Написать и задеплоить сабграф, который будет отображать текущее состояние стратегии на момент последней транзакции.

## Пример простой стратегии

Необходимо найти DeFi-протокол, который поощряет провайдеров ликвидности дополнительными вознаграждениями. Условия получения вознаграждений могут варьироваться: в некоторых протоколах потребуется застейкать LP-токен (токен, полученный от депозита в пул ликвидности).

Алгоритм работы стратегии может выглядеть следующим образом:
1. Стратегия вкладывает want-токены в пул ликвидности DeFi-протокола и получает LP-токен пула.
2. DeFi-протокол распределяет по пулу свои комиссии (т.е. стоимость LP-токена, которым владеет стратегия, растет) и начисляет вознаграждения.
3. Раз в сутки стратегия конвертирует вознаграждения в want-токены с помощью Uniswap и повторяет первый шаг.

## Требования к выполнению задания

- **Соблюдение лучших практик**. Код должен быть структурированным, читабельным, соответствовать базовым правилам безопасности.
- **Проверка кода с помощью Slither**. Допустимы только некоторые низкоприоритетные предупреждения, не представляющие угрозу безопасности.
- **Функции должны эмитить соответствующие события на изменение состояния смарт-контракта**. События должны содержать только важные данные, которые будут использоваться снаружи.
- **Необходимые проверки входных данных**. Например, проверка на нулевой адрес для токенов оплаты ERC-20, чтобы избежать ошибок или потерь средств.
- **Ограничение доступа к функциям смарт-контракта**. Использовать расширения Ownable или AccessControl для ограничения доступа к важным функциям протокола.
- **Во время проектирования архитектуры думайте об основных инвариантах протокола**. Инвариант — это свойство системы, которое никогда не должно нарушаться, например, сумма балансов всех держателей токенов должна соответствовать общему предложению токенов или количество токенов для перевода должно соответствовать фактически полученному количеству смарт-контрактом. Рекомендуется ознакомиться с подходами CEI (Checks-Effects-Interactions) и FREI-PI (Function Requirements-Effects-Interactions + Protocol Invariants).
- **Использование ReentrancyGuard от OpenZeppelin** для защиты функций смарт-контракта от повторных вызовов (где это необходимо).
- **Использовать стандарт ERC-4626**.
- **Проект должен быть разработан с использованием [Foundry](https://github.com/foundry-rs/foundry)**. Без использования Hardhat.
- **Должны быть написаны деплой-скрипты**. В формате ContractName.s.sol.
- **Покрытие юнит-тестами должно быть 100%**. Проверка должна выполняться через команду `forge test --coverage`.
- **Написание интеграционных тестов на форке мейннета**. Тесты должны подтвердить, что протокол может взаимодействовать с Uniswap и выбранным DeFi-протоколом для стратегии. Например, можно использовать версии Uniswap, начиная с v2, и DeFi-протоколы типа Compound v2.
- **Деплой смарт-контрактов в тестнет**. Смарт-контракты волта и стратегии должны быть верифицированы.
- **Рабочий сабграф**. Сабграф должен функционировать без ошибок и содержать основные сущности с данными. Необходимо подумать, какие данные могут понадобиться вашему web3-приложению на клиенте. Рекомендуется использовать сервисы с playground для API, такие как The Graph.
- **Документация**. Подробное описание по развертыванию, запуску проекта и по функционалу смарт-контрактов.
- **Видео-демонстрация работы сервиса**. Необходимо записать видео расшаренного экрана с демонстрацией работы сервиса, для ускорения ревью.
- **Репозиторий github**. Оформленный и задокументированный код необходимо предоставить для ревью в виде ссылки на репозиторий.

## Полезные ссылки

- Code: Волт от [Yearn](https://github.com/yearn/yearn-vaults/blob/main/contracts/Vault.vy). Для вдохновения. Написан на vyper, но его довольно легко понять
- Standard: [ERC-4626: Tokenized Vaults](https://eips.ethereum.org/EIPS/eip-4626)
- Article: [ERC-4626 Interface Explained](https://www.rareskills.io/post/erc4626)
